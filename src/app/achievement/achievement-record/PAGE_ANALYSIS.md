# 実績日報ページ (`page.tsx`) 分析レポート

## 概要

`/home/same/Developer/pmesystem/pmesystem/src/app/achievement/achievement-record/page.tsx` は、Next.jsのApp Routerアーキテクチャに基づいた実績日報入力システムのエントリーポイントです。このページは、プロジェクト管理システム（PMESystem）の一部として、ユーザーの業務実績を記録・管理するためのメインインターフェースを提供します。

## ページの役割と機能

このページは、実績日報入力システムのルートコンポーネントとして機能し、主に以下の役割を担っています：

1. **エントリーポイント**: Next.jsのApp Routerにおけるページコンポーネントとして、`/achievement/achievement-record` ルートにアクセスされた際にレンダリングされます。
2. **コンポーネント委譲**: 実際のUI実装は `AchivmentRecodePage` コンポーネントに委譲されており、ページコンポーネント自体は極めてシンプルな構造となっています。
3. **サーバーサイドレンダリング**: デフォルトエクスポートとして関数コンポーネントを提供することで、Next.jsのSSR（Server-Side Rendering）機能を活用できます。

## 全体レイアウト構造

### アプリケーション全体のレイアウト階層

実績日報ページは、`AppLayout` コンポーネントによって提供される共通レイアウト構造の中に配置されています。全体のレイアウト階層は以下の通りです：

```
RootLayout (layout.tsx)
└── AppLayout
    ├── SidebarProvider (shadcn/ui)
    │   ├── AppSidebar (左側ナビゲーションサイドバー)
    │   │   ├── SidebarHeader (ロゴ・タイトル)
    │   │   ├── SidebarContent (ページ固有のコンテンツ)
    │   │   └── SidebarFooter (ユーザー情報)
    │   ├── SidebarRail (サイドバーとメインコンテンツの境界線)
    │   └── SidebarInset (メインコンテンツ領域)
    │       ├── AppHeader (上部ヘッダー)
    │       └── main (ページコンテンツ)
    │           └── AchivmentRecodePage (実績日報ページ)
```

### ヘッダー (`AppHeader`)

ヘッダーは、アプリケーション全体の上部に固定表示されるナビゲーション領域です。

**配置**:
- `sticky top-0` により、スクロール時も常に画面最上部に固定表示されます
- `z-0` のz-index設定により、他の要素の下に配置されます
- `SidebarInset` 内の `flex flex-col` レイアウトの最初の要素として配置されます

**構造**:
- **`HeaderNavigationSection`**: サイドバーの開閉を制御する `SidebarTrigger` ボタンを表示
  - サイドバーの表示/非表示を切り替えるトグルボタンとして機能
  - クリックにより、左側のナビゲーションサイドバーを開閉できます
- **`HeaderAuthSection`**: 認証状態に応じた認証関連UIを表示
  - セッション未取得時: 何も表示しない（ローディング中）
  - セッション存在時: 何も表示しない（ユーザー情報はサイドバーフッターに表示）
  - 未認証時: 「サインイン」と「サインアップ」ボタンを表示

**サイズ**:
- 高さは `display-size-context` から取得した `headerHeight` に基づいて動的に設定されます
- コンテナ幅は `container` クラスにより制限され、中央配置されます

**技術的特徴**:
- `border-b` により下部に境界線を表示
- `bg-sidebar` により、サイドバーと同じ背景色を適用して統一感を保持

### サイドバー (`AppSidebar`)

サイドバーは、アプリケーション全体の左側に配置されるナビゲーション領域です。

**配置**:
- `SidebarProvider` 内に配置され、shadcn/uiのサイドバーコンポーネントシステムを使用
- デフォルトで開いた状態（`defaultOpen={true}`）で表示されます
- 幅は `mainSidebarWidth` に基づいてCSS変数 `--sidebar-width` として設定されます

**構造**:
- **`SidebarHeader`**: サイドバーの上部ヘッダー
  - PME Systemのロゴとタイトルを表示
  - ホームページへのリンクとして機能
  - アイコンサイズとフォントサイズは `headerHeight` に基づいて動的に計算されます
  - 高さは `headerHeight` と同じ値に設定されます

- **`SidebarContent`**: サイドバーのメインコンテンツ領域
  - **通常ページ**: メインメニュー項目を表示（プロジェクト、タスク、ユーザーなど）
  - **実績日報ページ (`/achievement/achievement-record`)**: 特別なコンテンツ `AchievementRecordSidebarSection` を表示

- **`SidebarFooter`**: サイドバーの下部フッター
  - 認証済みユーザーの情報を表示（`NipponSteelUserButton`）
  - セッションがない場合は何も表示しません

**実績日報ページ特有のサイドバーコンテンツ** (`AchievementRecordSidebarSection`):

実績日報ページでは、サイドバーのコンテンツが通常のメニューから以下の特別なセクション構成に変更されます：

1. **カレンダーセクション**:
   - 日付選択と表示期間の操作機能（現時点ではサンプル表示）
   - 月表示と週表示の切り替え機能（将来的な実装予定）

2. **メニューセクション**:
   - プロジェクト参加 (`project-join`)
   - プロジェクト追加 (`project-create`)
   - プロジェクト一覧 (`project-list`)
   - プロジェクトタスク作成 (`project-task-create`)
   - タスク (`tasks`)
   - 過去実績 (`past-records`)
   - 各メニュー項目は、クリック時に `activeView` 状態を更新し、左セクションのコンテンツを切り替えます

3. **データ管理セクション**:
   - タスク種類管理 (`task-types-management`)
   - 設備管理 (`equipment-management`)
   - タスク作成 (`task-create`)
   - マスターデータの管理機能を提供

4. **アクションセクション**:
   - Outlook連携などの外部システム連携機能（現時点ではサンプル表示）
   - クイックアクション機能を提供

**サイドバーと左セクションの関係**:
- サイドバー内のメニュー項目をクリックすると、`useMenuContext` を通じて `activeView` が更新されます
- `AchivmentRecodePage` コンポーネントは、この `activeView` の値を監視し、それに応じて左セクション（`LeftSection`）のコンテンツを動的に変更します
- つまり、サイドバーは「操作パネル」として機能し、左セクションは「操作結果の表示領域」として機能します

## コンポーネント構造と配置

### 3カラムレイアウトアーキテクチャ

`AchivmentRecodePage` コンポーネントは、3つの主要セクションから構成される非対称的なレイアウトを採用しています：

#### 1. 左セクション (`LeftSection`)

左セクションは、動的なコンテンツ表示を担う可変サイドバーです。

**配置**: 
- `absolute` ポジショニングではなく、`flex` レイアウト内の `shrink-0` として配置されています
- 幅は `mainSidebarWidth` に基づいて動的に計算されます
- 表示/非表示は `isVisible` 状態によって制御されます

**機能**:
- **プロジェクト管理**: プロジェクトの参加、作成、一覧表示機能を提供
- **タスク管理**: タスク種類の管理、設備管理、タスク作成機能を統合
- **動的コンテンツ切り替え**: `useMenuContext` から取得した `activeView` に基づいて、以下のビューを切り替えます：
  - `project-join`: プロジェクト参加画面
  - `project-create`: プロジェクト追加画面
  - `project-list`: プロジェクト一覧画面
  - `task-types-management`: タスク種類管理画面
  - `equipment-management`: 設備管理画面
  - `task-create`: タスク作成画面
  - `tasks`: タスク管理画面（開発中）
  - `past-records`: 過去実績表示画面（開発中）

**内部構造**:
- `LeftTopSection`: タイトルとサブタイトルを表示するヘッダー部分
- `LeftBottomSection`: 実際のコンテンツを表示するメイン部分

#### 2. 中央セクション (`CenterSection`)

中央セクションは、実績日報システムの核心となる時間グリッド表示エリアです。

**配置**:
- `flex-1` クラスにより、残りのスペースを埋めるように配置されます
- 左セクションの表示状態に応じて幅が動的に調整されます（非表示時は `mainSidebarWidth * 4.5`、表示時は `mainSidebarWidth * 3.5`）

**機能**:
- **時間グリッド表示**: `TimeGridTable` コンポーネントを使用して、週単位または月単位の時間軸表示を実現
- **ドラッグ&ドロップ**: `react-dnd` ライブラリを使用したタスクの時間移動機能
- **タスク管理**: タスクの作成、更新、削除、複製機能を提供
- **実績表示**: タスクと実績（Achievement）を統合的に表示

**技術的特徴**:
- `DndProvider` により、HTML5バックエンドを使ったドラッグ&ドロップ機能を実装
- サンプルデータを使用した開発段階の実装（将来的にはAPIからデータを取得）

#### 3. 右セクション (`RightSection`)

右セクションは、現時点ではプレースホルダーとして機能しています。

**配置**:
- `absolute` ポジショニングにより、画面右端に固定配置されています
- 幅は `mainSidebarWidth * 1.5` で計算されます

**機能**:
- 実績・成果表示エリアとして設計されているが、現時点では実装が未完了
- 将来的には、選択したタスクや実績の詳細情報を表示する予定

## 状態管理とコンテキスト

### 使用されているコンテキスト

1. **`useLeftSection`**: 左セクションの表示状態を管理するコンテキスト
   - `isVisible`: 左セクションの表示/非表示フラグ
   - `leftSectionData`: 左セクションに表示するデータ（タイトル、サブタイトル、コンテンツ）

2. **`useMenuContext`**: メニューのアクティブビューを管理するコンテキスト
   - `activeView`: 現在選択されているメニュー項目の識別子

3. **`display-size-context`**: 画面サイズ情報を提供するコンテキスト
   - `mainSidebarWidth`: メインサイドバーの幅
   - `displayHeight`: 表示領域の高さ
   - `headerHeight`: ヘッダーの高さ

### レイアウト計算ロジック

各セクションのサイズは、コンテキストから取得した値に基づいて動的に計算されます：

```typescript
sectionHeight = displayHeight - headerHeight
```

この計算により、ヘッダーを除いた利用可能な高さを確保し、各セクションが適切に配置されます。

## レスポンシブ動作

左セクションの表示/非表示に応じて、中央セクションの幅が動的に調整されます：

- **左セクション表示時**: 中央セクションは `mainSidebarWidth * 3.5` の幅で表示
- **左セクション非表示時**: 中央セクションは `mainSidebarWidth * 4.5` の幅に拡張され、より広い作業領域を提供

この動作により、ユーザーは必要に応じて作業領域を最大化できます。

## 設計パターンとベストプラクティス

### 関心の分離

- **ページコンポーネント**: Next.jsのルーティングと統合するだけのシンプルなラッパー
- **機能コンポーネント**: 実際のUI実装とビジネスロジックを担当

### コンポーネント分割

- 各セクションは独立したコンポーネントとして分離され、保守性と再利用性を確保
- セクション内のサブコンポーネントも適切に分割され、責務が明確化されています

### 動的コンテンツ管理

- `getLeftSectionProps` 関数により、メニュー選択に応じた動的なコンテンツ切り替えを実現
- 各ビューに対する適切なプロパティ（タイトル、サブタイトル、コンテンツ）を一元管理

## 今後の拡張可能性

1. **データフェッチング**: 現在はサンプルデータを使用しているが、将来的にはAPIからリアルタイムにデータを取得
2. **右セクションの実装**: 実績詳細表示機能の完全実装
3. **パフォーマンス最適化**: 大量データ表示時の仮想スクロールやレンダリング最適化
4. **アクセシビリティ**: キーボードナビゲーションやスクリーンリーダー対応の強化

## まとめ

このページは、実績日報入力システムの中心的なインターフェースとして、アプリケーション全体のレイアウト構造（ヘッダー・サイドバー）とページ固有の3カラムレイアウトを組み合わせた効率的な情報管理を実現しています。

**全体レイアウト構造**:
- **ヘッダー**: 上部に固定表示され、サイドバーの開閉制御と認証状態の表示を担当
- **サイドバー**: 左側に配置され、実績日報ページでは特別なカレンダー・メニュー・データ管理・アクションセクションを表示
- **メインコンテンツ領域**: ヘッダーとサイドバーに囲まれた領域に、実績日報ページの3カラムレイアウトが配置されます

**ページ固有の3カラムレイアウト**:
- **左セクション**: サイドバーのメニュー選択に応じて動的にコンテンツが切り替わる、プロジェクト・タスク管理の表示領域
- **中央セクション**: 時間軸ベースの実績表示とドラッグ&ドロップ機能を提供するメイン作業領域
- **右セクション**: 実績詳細情報を表示する予定の領域（現時点では実装未完了）

この設計により、ユーザーはサイドバーから操作を選択し、左セクションでその操作結果を確認・編集し、中央セクションで時間軸ベースの実績を管理できる、直感的で効率的な業務実績記録・管理環境を提供しています。コンテキストベースの状態管理と動的なレイアウト調整により、柔軟で拡張性の高い設計となっています。

